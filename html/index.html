<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h1>测试数据</h1>
    <h3>url参数拼接?redirectUrl=https://www.baidu.com&isCurPagePlay=false&isJump=true</h3>
    <script>
      class EventBus{
        constructor(){
          // 事件池
          this.listeners ={}
        }
        on(type,cb){
          if(!this.listeners[type]){
            this.listeners[type]=[]
          }
          this.listeners[type].push(cb)
        }
        emit(type,...res){
          if(!this.listeners[type]){
            return
          }
          this.listeners[type].forEach(item=>{
            item.apply(this,res)
          })
        }
        /**
         * 移除事件监听
         * 传两个参 移除该事件类型的 回调函数
         * 传一个类型 移除该类型下的所有回调函数列表
         * @param {*} type
         * @param {*} cb
         */
        off(type,cb){
          if(this.listeners[type]){
            const index=this.listeners[type].findIndex(item=>item===cb)
            if(index>=0){
              this.listeners.splice(index,1)
            }
            // 只是传type，移除该事件的所有监听者
            if(this.listeners[type].length===0){
              delete this.listeners[type]
            }
          }
        }
         /**
         * 只被触发一次的事件
         * @param {String} type 事件类型
         * @param {Function} fn 回调函数
         */
        once(type,fn){
          const cb=(...args)=>{
            fn(...args)
            this.off(type,cb)
          }
          this.on(type,cb)
        }

      }


      const getPageParams=(url)=>{
        if(!url){
          return
        }
        let obj={};
        url.replace(/([^?#=&]+)=([^?#=&]+)/g,(...res)=>{
          obj[res[1]]=res[2]
        })
        url.replace(/#([^?#=&]+)/g,(...res)=>{
          obj.HASH=res[1]
        })
        return obj;
      }
      
      const eventBus=new EventBus()
      eventBus.on('pageShowEnd',(res)=>{
        let url=window.location.href
        let urlParames=getPageParams(url)
        const {isJump,redirectUrl} = urlParames
        if(`${isJump}`==='true'){
          window.location.href=redirectUrl;
        }else{
          console.log('closeWebview')
        }
        
      })
      setTimeout(()=>{
        eventBus.emit('pageShowEnd','测试')
      },3000)
      const judeJump=()=>{
        let url=window.location.href
        let urlParames=getPageParams(url)
        const {isCurPagePlay,isJump,redirectUrl} = urlParames
        if(`${isJump}`==='true'&&`${isCurPagePlay}`!=='true'){
          window.location.href=redirectUrl;
        }
      }
      judeJump()

    </script>
  </body>
</html>
